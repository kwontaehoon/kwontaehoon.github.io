---
layout : post
title : AWS HTTPS와 실서버 API 함께 배포
categories : AWS
date : 2024-04-27
---

## 배경

### 기존 AWS의 EC2 서비스를 이용해서 배포를 진행했던 방식
- EC2와 웹 서버인 Nginx를 이용해서 FE 빌드파일을 업로드한다.
- EC2의 무중단 배포를 이용해서 BE 빌드파일을 이용해서 서버를 실행 켜준다.

진행과정은 심플했다. 가상 컴퓨터에서 서버를 실행시키고 화면은 빌드해서 부착해주면 끝나기 때문이다.

<br />

하지만 진행한 배포를 HTTP에서 HTTPS로 바꾸는 과정과 만들어둔 REST API를 배포하는 과정이 정말 어려웠다. 포털 사이트에서 HTTP에서 HTTPS로 바꾸는 과정에 대한 포스팅은 많아서 쉽게 했지만 REST API를 접목시키는것이 어려웠다. 이 과정을 하다가 안되서 포기하고 다시함을 두달간 반복하다가 해당 문제에 대한 원인을 찾아서 마침내 해결했다. 이 해결과정을 정리해보겠다.

<br />

## 해결 과정

### HTTP -> HTTPS
- AWS Route53에서 도메인 구입
- SSL 발급을 위해서 ACM에서 인증서 발급
-- 이 과정에서 DNS 검증을 통해서 한번에 발급을 받았지만 시행착오 때문에 어찌저찌해서 기존에 발급한 인증서를 지우고 다시 DNS 검증을 통해서 재발급을 요청했다. 하지만 3일이 지나도 응답이 오지않았고 요청시간초과 오류가 발생했다. 한참을 서치하고 AWS에 문의하고 별의별 방법을 통해서 찾아봤지만 AWS 측은 ACM 발급 과정단계 링크만 보냈다. 그래서 DNS 인증말고 이메일 인증을 받아봤는데 한참을 오지않다가 이것도 안되겠다해서 포기하던 중 이메일 인증을 재발급을 누르고나서 5분후에 인증 이메일이 도착했다. 그래서 저는 이메일 인증을 사용해서 SSL 인증서를 재발급 받았다.
- 타겟그룹을 만들고 로드밸런서를 만든다. SpringBoot는 8080을 이용한다.
- Route53에서 A레코드를 생성하여 해당 로드밸런서를 매칭시킨다.

배포는 잘된다. 퍼블리싱만. 하지만 모든 페이지에서 데이터를 요청하기때문에 404로 REST API의 데이터가 오지않았다. 여기서 또 헤맨점. 바로 레코드 유형 4개의 값들이다. 자동으로
Route53 등록된 도메인의 NS 값들과 매칭해주는줄 알았으나 그게아니였다. 호스팅 영역 ★세부정보★에서 생성한 레코드 유형 4개를 가지고 등록된 도메인의 NS 값들을 변경해줘야했다. 그리고 또 호스팅 영역의 NS 유형도 똑같이 변경해줘야한다. 총 3개 값들으 모두 똑같이 해줘야했던것이다.

### 로드밸런서 / S3, CloudFront

저는 로드밸런서를 이용해서 해결을 못했다. 정확히 Nginx와 로드밸런서 사이의 통신 과정을 이해하지못했기 때문이다. 네트워크 지식이 중요함을 정말 이 과정에서 꺠달았다. 여기서는 S3와 CloudFront를 이용해서 해결했기 때문에 이 과정을 적어보겠다.

- CloudFront의 SSL은 버지니아 북부의 ACM을 사용하기 떄문에 버지니아 북부 ACM 발급
- S3에 빌드한 FE 파일 업로드
- 만든 S3를 이용해서 CloudFront 생성
- 엔드포인트 /api/와 /admin/을 위해 원본파일 EC2 생성
- 동작 또한 /api/* 와 /admin/* 생성
- Route53의 A 레코드에서 별칭을 활성화하여 ClodeFront 매칭

처음에 S3와 CloudFront를 이용하여 배포를 진행하면서 로드밸런서를 이용했을 때와 똑같은 오류를 경험했다. Postman에서 서버의 응답으로 404로 html 파일을 뱉는것이였다. 하지만 설정에 따른 딜레이 때문에 응답으로 404가 발생한것이였다. 인내심을 가지고 몇분 기다려보면 도메인 주소로된 REST API에서 IP주소로된 REST API처럼 응답값이 똑같이 오는것을 확인할 수 있었다.

### 결론

- HTTP -> HTTPS로 정적파일을 배포하는것은 간단한다.
- IP 주소로된 REST API를 도메인 주소로 바꾸는 과정을 잘 살펴봐야한다.
-- SSL DNS 검증 뿐만아니라 이메일 인증도 시간을 가지고보면 잘 응답한다.
-- 엔드포인트를 잘 살피자. 저는 사용자 API를 /api, 관리자 API를 /admin으로 했기 때문에 총 2개를 설정해야한다.
-- 엔드포인트를 설정하지않고 A 레코드로 도메인을 등록하게되면 서버에서 404 html 응답을 한다.


### 다음 단계

- 다시 돌아가서 타겟그룹을 생성하여 로드밸런서로 배포 진행